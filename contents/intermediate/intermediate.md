# 中級編: ババ抜きをクラスを使って整頓する

---

## 目次

1. [初級編の振り返り](#1)
2. [クラスで整頓する](#2)
    1. [クラスの効果](#2-0)
    1. [ババ抜きの構成を見る](#2-1)
    1. [一からクラスを構築する](#2-2)
    1. [setupメソッドの移行](#2-3)

---

## <a name=1>初級編の振り返り</a>

- 初級編は**可読性**を重視してリーダブルにした
- ボトムアップ方式でコードを分割していった
    - 先に動くコードを書いて後から分割する
- ソースが暗号に近い上にアニメーションの処理が複雑なため難解だった

### 各工程での考察

1. 表面上の改善
- ただの作業
- 行数が多いと後からこの部分を改善するのは面倒
- 最初から表面的に綺麗にしておくべき

2-1. 解読
- 最も難しい工程
- 本来自分のコードは解読する必要ないので本意ではない

2-2. コメントを挿入
- この段階では全てを理解する必要はない
- 大まかに何をやっているかだけ把握するためのコメント
- 疑問が浮かぶ箇所はメモしておくとよい

3. 適切な名前付け
- 最も悩む工程
- 人の好みが出やすく経験による
- 人のコードを読むことでも語彙が増える (TIPSも参照)

4-1. 変数で分割する
- コードの横幅を狭める工程
- 変数による名前付けという効果もある
- この段階ではほとんどがifの条件文の分割

4-2. スコープを縮める
- 変数の使用箇所を一つ一つ見る
- draw()内でしか使われてない変数は中級編で解決するのでスルー
- クラスなしではあまり効果が現れない

5-1. メソッドで分割する
- 最も効果が現れる工程
- コメントに沿って大まかなくくりで分ける

5-2. ファイルで分割する
- 1ファイル当たりの行数を減らす工程

### 初級編の成果

- [ここ](../beginner/readableBabanuki_5.zip)まで掃除できた
- しかし…
    - 22個のグローバル変数
    - 多くのフラグと一時変数
    - 多くのメソッドがvoidで引数が少ない
    - プレイヤーによって使うメソッドが異なる
    - 複雑なアニメーション
- ただ箱に詰めた感じが残る

---

## <a name=2>**クラス**で整頓する</a>

---

### <a name=2-0>クラスの効果</a>
- 似たような処理を共通化
- 可読性だけでなく拡張性も高められる

### <a name=2-1>1. ババ抜きの構成を見る</a>

- 初級編の[プログラム構成](../beginner/beginner.md#4-4)に従って構築すればよい
- カード、プレイヤー、場の3つのクラスを作る

### <a name=2-2>2. 一からクラスを構築する</a>

- まず従来のコードは置いておいて枠組みだけ作る
- 1ファイル1クラスを守る
- ファイル名はクラス名と同じにする

#### 手順

1. クラスを作る、コメントを書く
2. インスタンス変数を作る
3. コンストラクタを作る
4. インスタンス化する

#### [サンプルコード](readableBabanuki_1.zip)

### 3. setupメソッドの移行

- 初級編で作ったコードから移行を始める
- なお単純化のためサンプルでは[アニメーション削除版](./contents/beginner/readableBabanuki_5_no_animations.zip)を使用する
- まずはゲームの初期化を含むsetupメソッドから
- 基本的には従来のアルゴリズムを継承するべきだが、自分でよりよいアルゴリズムが思いつけばそれを採用してもよい
- 名前はできるだけ従来のコードを真似すること

#### [サンプルコード](readableBabanuki_2.zip)

#### [補足] `discardPairCards`について
- ペアを捨てるメソッドだが実装方法がいくつかある
- 2つの組を捨てるため3つの組がある場合どれか1つは捨ててはならないことに注意
- [リストから重複する値のペアを探索して削除するアルゴリズム](discardPairCards_algorithm.zip)

#### [余談] アルゴリズムの実装について
- 基本的には実際にプレイする様子を思い浮かべてその通りに実装すればよい
    - `dealCards`の場合、山札をシャッフルして交互に配る
    - ランダムに何かする = `random()`を使うではない
- リアルな行為に近いアルゴリズムは直感的で分かりやすい
- 効率と可読性、拡張性はしばしトレードオフになる

### 4. UI関連以外のメソッドの移行

- まずはUIを考えずカードに関するメソッドを移行する
- 引数で扱うオブジェクトが変わることに注意

#### [サンプルコード](readableBabanuki_3.zip)

#### [余談] テストについて
- メソッドを実装したらそれが正しく動くかテストする必要がある
- 画面上と実際の動きは異なることもあるので、通常コンソールでテストする
- しかし現時点ではテストに必要な検証メソッドを備えていないので簡単なテストのみ行う
    - カードを文字で表すことが難しい
    - 上級編ではテストしやすくする技も学ぶ
- サンプルコードでは実装したメソッドをテストしたコードを追加している (コンソール出力はなし)